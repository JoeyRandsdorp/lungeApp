import{DrawingUtils as x,FilesetResolver as L,PoseLandmarker as w}from"https://cdn.skypack.dev/@mediapipe/tasks-vision@0.10.0";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();class E{constructor(e,t=[]){this.k=e,this.training=t,this.training.length===0?this.array_size=-1:this.array_size=this.training[0].v.length}dist(e,t){let n=0;return e.forEach((a,s)=>{n+=Math.pow(a-t[s],2)}),Math.sqrt(n)}updateMax(e,t){let n=0;for(let a of t)n=Math.max(n,a.d);return n}mode(e){let t={},n=0,a;for(let s in e)t[e[s]]=(t[e[s]]||0)+1,t[e[s]]>n&&(n=t[e[s]],a=e[s]);return a}checkInput(e){if(Array.isArray(e))if(e.length>0)if(typeof e[0]=="number")if(this.array_size>-1){if(e.length==this.array_size)return!0;console.error(`Learn en classify verwachten een array met numbers van dezelfde lengte, je stuurt nu een array met lengte ${e.length}, terwijl je eerder lengte ${this.array_size} gebruikt hebt.`)}else return this.array_size=e.length,!0;else console.error(`Learn en classify verwachten een array met numbers, je stuurt nu array met ${typeof e[0]}.`);else console.error("Learn en classify verwachten een array met numbers, je stuurt nu lege array.");else console.error(`Learn en classify verwachten een array met numbers, je stuurt nu geen array, maar ${typeof e}.`);return!1}learn(e,t){this.checkInput(e);let n={v:e,lab:t};this.training.push(n)}classify(e){this.checkInput(e);let t=[],n=0;for(let s of this.training){let i={d:this.dist(e,s.v),vote:s.lab};if(t.length<this.k)t.push(i),n=this.updateMax(n,t);else if(i.d<n){let f=!0,u=0;for(;f;)Number(t[u].d)===n?(t.splice(u,1,i),n=this.updateMax(n,t),f=!1):u<t.length-1?u++:f=!1}}let a=[];for(let s of t)a.push(s.vote);return this.mode(a)}}const l=document.getElementById("webcam"),c=document.getElementById("output_canvas"),d=document.getElementById("webcamButton"),O=document.getElementById("stopWebcamButton"),B=document.getElementById("logButton"),g=c.getContext("2d"),y=new x(g);let m,h=!1,o;const b="480px",k="270px",j=3,p=new E(j);fetch("/lungeApp/lunge.json").then(r=>r.json()).then(r=>{P(r)}).catch(r=>console.log(r));function M(){(()=>{let e;return!!(!((e=navigator.mediaDevices)===null||e===void 0)&&e.getUserMedia)})()?_():console.warn("getUserMedia() is not supported by your browser")}const _=async()=>{const r=await L.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");m=await w.createFromOptions(r,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:2}),d.addEventListener("click",A),B.addEventListener("click",e=>z()),O.addEventListener("click",C)};function A(r){if(console.log("start the webcam"),!m){console.log("Wait! poseLandmaker not loaded yet.");return}h=!0,d.innerText="Predicting",d.disabled=!0;const e={video:{width:{exact:720},height:{exact:405}}};navigator.mediaDevices.getUserMedia(e).then(t=>{l.srcObject=t,l.addEventListener("loadeddata",async()=>{c.style.height=k,c.style.width=b,l.style.height=k,l.style.width=b,await m.setOptions({runningMode:"VIDEO"}),v()})})}async function v(){const r=await m.detectForVideo(l,performance.now());if(o=r,I(r),o&&o.landmarks&&o.landmarks[0]){const e=o.landmarks[0].map(n=>[n.x,n.y,n.z]).flat(),t=p.classify(e);console.log("Voorspelling:",t),N(t)}h===!0&&window.requestAnimationFrame(v)}function I(r){g.clearRect(0,0,c.width,c.height);for(const e of r.landmarks)y.drawLandmarks(e,{radius:3}),y.drawConnectors(e,w.POSE_CONNECTIONS)}function P(r){if(!Array.isArray(r)){console.error("Training data not in expected format.");return}for(let e of r)Array.isArray(e.points)&&typeof e.label=="string"?p.learn(e.points,e.label):console.warn("Skipping invalid pose entry:",e)}function z(){if(!o||!o.landmarks){console.warn("Nog geen resultaten beschikbaar");return}const r=o.landmarks[0].map(t=>[t.x,t.y,t.z]).flat(),e=p.classify(r);console.log("Voorspelling:",e),console.log("Landmarks (rauw):",o.landmarks[0])}function N(r){const e=["red","red","red"];switch(r){case"goed":e[0]="green",e[1]="green",e[2]="green";break;case"vFrame":e[2]="green";break;case"dKnie":e[0]="green";break;case"aFrame":e[1]="green";break;case"frame":e[1]="green",e[2]="green";break;case"aKnie":e[0]="green",e[1]="green";break;case"vKnie":e[1]="green",e[2]="green";break}for(let t=0;t<3;t++){const n=document.getElementById(`box${t+1}`);n.classList.remove("bg-red-500","bg-green-500"),n.classList.add(`bg-${e[t]}-500`)}}function C(){h=!1,d.innerText="START WEBCAM",d.disabled=!1;const r=l.srcObject;r&&r.getTracks().forEach(t=>t.stop()),l.srcObject=null,g.clearRect(0,0,c.width,c.height),console.log("Webcam gestopt")}M();
